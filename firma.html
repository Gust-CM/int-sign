<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Firma de Acción de Personal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:16px;background:#f7f7f8}
    .card{max-width:560px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.08);padding:16px}
    h1{font-size:18px;margin:0 0 8px}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input,button{width:100%}
    canvas{width:100%;height:220px;border:1px solid #ddd;border-radius:8px;background:#fff}
    .row{display:flex;gap:8px;margin-top:8px}
    .row>button{flex:1}
    small{color:#666}
  </style>
</head>
<body>
  <div class="card">
    <h1>Firma de Acción de Personal</h1>
    <p id="info">Cargando…</p>

    <label>Nombre del colaborador</label>
    <input id="nombre" placeholder="Tu nombre completo" />

    <label>Firma (usa tu dedo)</label>
    <canvas id="pad" width="520" height="220"></canvas>
    <div class="row">
      <button id="limpiar" type="button">Limpiar</button>
      <button id="firmar" type="button">Enviar firma</button>
    </div>

    <p style="margin-top:12px"><small>
      Al presionar “Enviar firma”, confirmo que esta firma corresponde a mi consentimiento para la acción indicada.
    </small></p>

    <div id="ok"  style="margin-top:10px;color:#0b6;display:none"></div>
    <div id="err" style="margin-top:10px;color:#b00;display:none"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script>
    const qs   = new URLSearchParams(location.search);
    const id   = qs.get('id');
    const otp  = qs.get('otp');
    const info = document.getElementById('info');
    info.textContent = (id && otp) ? `Acción: ${id} • Código: ${otp}` :
      'Falta el identificador o el código. Revisa tu enlace.';

    const canvas  = document.getElementById('pad');
    const pad     = new SignaturePad(canvas, {backgroundColor:'#fff'});

    function resize(){
      const ratio = Math.max(window.devicePixelRatio||1,1);
      canvas.width  = canvas.offsetWidth * ratio;
      canvas.height = 220 * ratio;
      canvas.getContext('2d').scale(ratio, ratio);
      pad.clear();
    }
    addEventListener('resize', resize); resize();

    document.getElementById('limpiar').onclick = ()=> pad.clear();
    document.getElementById('firmar').onclick  = async ()=>{
      const ok  = document.getElementById('ok');
      const err = document.getElementById('err');
      ok.style.display = err.style.display = 'none';

      const nombre = document.getElementById('nombre').value.trim();
      if(!id || !otp){ err.textContent='Enlace inválido.'; err.style.display='block'; return; }
      if(!nombre){     err.textContent='Ingresa tu nombre.'; err.style.display='block'; return; }
      if(pad.isEmpty()){err.textContent='Dibuja tu firma.';  err.style.display='block'; return; }

      const firmaBase64 = pad.toDataURL('image/png');

      try{
        const res = await fetch('https://webhook.site/339f1ec0-11d3-4550-b0b2-ab45a24f3b82gi', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            id, otp, nombre,
            firmaBase64,
            userAgent: navigator.userAgent,
            tsClient: new Date().toISOString()
          })
        });
        if(!res.ok) throw new Error('No se pudo registrar la firma');
        ok.textContent   = '¡Firma enviada! Gracias.';
        ok.style.display = 'block';
      }catch(e){
        err.textContent   = 'Error enviando la firma. Intenta de nuevo.';
        err.style.display = 'block';
      }
    };
  </script>
</body>
</html>
